CREATE DATABASE QLBH_21521652
------------------------------------------------------------------------------------------------------------------------------------
--I
--1
CREATE TABLE KhachHang(
	MAKH	char(4) not null,	
	HOTEN	varchar(40),
	DCHI	varchar(50),
	SODT	varchar(20),
	NGSINH	smalldatetime,
	NGDK	smalldatetime,
	DOANHSO	money,
	CONSTRAINT pk_kh PRIMARY KEY(MAKH)
)

CREATE TABLE NhanVien(
	MANV	char(4) not null,	
	HOTEN	varchar(40),
	SODT	varchar(20),
	NGVL	smalldatetime	
	CONSTRAINT pk_nv PRIMARY KEY(MANV)
)

CREATE TABLE SanPham(
	MASP	char(4) not null,
	TENSP	varchar(40),
	DVT	varchar(20),
	NUOCSX	varchar(40),
	GIA	money,
	CONSTRAINT pk_sp PRIMARY KEY(MASP)	
)

CREATE TABLE HoaDon(
	SOHD	int not null,
	NGHD 	smalldatetime,
	MAKH 	char(4),
	MANV 	char(4),
	TRIGIA	money,
	CONSTRAINT pk_hd PRIMARY KEY(SOHD)
)

CREATE TABLE CTHD(
	SOHD	int,
	MASP	char(4),
	SL	int,
	CONSTRAINT pk_CTHD PRIMARY KEY(SOHD,MASP)
)

ALTER TABLE HoaDon ADD CONSTRAINT fk01_HD FOREIGN KEY(MAKH) REFERENCES KhachHang(MAKH)
ALTER TABLE HoaDon ADD CONSTRAINT fk02_HD FOREIGN KEY(MANV) REFERENCES NhanVien(MANV)
ALTER TABLE CTHD ADD CONSTRAINT fk01_CTHD FOREIGN KEY(SOHD) REFERENCES HoaDon(SOHD)
ALTER TABLE CTHD ADD CONSTRAINT fk02_CTHD FOREIGN KEY(MASP) REFERENCES SanPham(MASP)
--2
ALTER TABLE SanPham ADD GHICHU VARCHAR(20)
--3
ALTER TABLE KhachHang ADD LOAIKH TINYINT 
--4
ALTER TABLE SanPham ALTER COLUMN GHICHU VARCHAR(100)
--5
ALTER TABLE SanPham DROP COLUMN GHICHU
--6
ALTER TABLE KhachHang ALTER COLUMN LOAIKH VARCHAR(50)
--7
ALTER TABLE SanPham ADD CONSTRAINT CHECK_DVT CHECK(DVT='CAY'OR DVT='CAI'OR DVT='HOP'OR DVT='QUYEN'OR DVT='CHUC')
--8
ALTER TABLE SanPham ADD CONSTRAINT CHECK_GIA CHECK(GIA>=500)
--10
ALTER TABLE KhachHang ADD CONSTRAINT CHECK_NGDK CHECK (NGDK>NGSINH)

SET DATEFORMAT DMY
-----------------------------------------------------------------------------------------------------------------------------------
--II

--1
INSERT INTO KhachHang VALUES('KH01','Nguyen Van A','731 Tran Hung Dao, Q5, TpHCM','8823451','22/10/1960','22/07/2006',13060000)
INSERT INTO KhachHang VALUES('KH02','Tran Ngoc Han','23/5 Nguyen Trai, Q5, TpHCM','908256478','03/04/1974','30/07/2006',280000)
INSERT INTO KhachHang VALUES('KH03','Tran Ngoc Linh','45 Nguyen Canh Chan, Q1, TpHCM','938776266','12/06/1980','08/05/2006',3860000)
INSERT INTO KhachHang VALUES('KH04','Tran Minh Long','50/34 Le Dai Hanh, Q10, TpHCM','917325476','09/03/1965','10/02/2006',250000)
INSERT INTO KhachHang VALUES('KH05','Le Nhat Minh','34 Truong Dinh, Q3, TpHCM','8246108','10/03/1950','28/10/2006',21000)
INSERT INTO KhachHang VALUES('KH06','Le Hoai Thuong','227 Nguyen Van Cu, Q5, TpHCM','8631738','31/12/1981','24/11/2006',915000)
INSERT INTO KhachHang VALUES('KH07','Nguyen Van Tam','32/3 Tran Binh Trong, Q5, TpHCM','916783565','06/04/1971','12/01/2006',12500)
INSERT INTO KhachHang VALUES('KH08','Phan Thi Thanh','45/2 An Duong Vuong, Q5, TpHCM','938435756','10/01/1971','13/12/2006',365000)
INSERT INTO KhachHang VALUES('KH09','Le Ha Vinh','873 Le Hong Phong, Q5, TpHCM','8654763','03/09/1979','14/01/2007',70000)
INSERT INTO KhachHang VALUES('KH10','Ha Duy Lap','34/34B Nguyen Trai, Q1, TpHCM','8768904','02/05/1983','16/01/2007',67500)

INSERT INTO NhanVien VALUES('NV01','Nguyen Nhu Nhut','927345678','13/04/2006')
INSERT INTO NhanVien VALUES('NV02','Le Thi Phi Yen','987567390','21/04/2006')
INSERT INTO NhanVien VALUES('NV03','Nguyen Van B','997047382','27/04/2006')
INSERT INTO NhanVien VALUES('NV04','Ngo Thanh Tuan','913758498','24/06/2006')
INSERT INTO NhanVien VALUES('NV05','Nguyen Thi Truc Thanh','918590387','20/07/2006')

INSERT INTO SanPham VALUES('BC01','But chi','cay','Singapore',3000)
INSERT INTO SanPham VALUES('BC02','But chi','cay','Singapore',5000)
INSERT INTO SanPham VALUES('BC03','But chi','cay','Viet Nam',3500)
INSERT INTO SanPham VALUES('BC04','But chi','hop','Viet Nam',30000)
INSERT INTO SanPham VALUES('BB01','But bi','cay','Viet Nam',5000)
INSERT INTO SanPham VALUES('BB02','But bi','cay','Trung Quoc',7000)
INSERT INTO SanPham VALUES('BB03','But bi','hop','Thai Lan',100000)
INSERT INTO SanPham VALUES('TV01','Tap 100 giay mong','quyen','Trung Quoc',2500)
INSERT INTO SanPham VALUES('TV02','Tap 200 giay mong','quyen','Trung Quoc',4500)
INSERT INTO SanPham VALUES('TV03','Tap 100 giay tot','quyen','Viet Nam',3000)
INSERT INTO SanPham VALUES('TV04','Tap 200 giay tot','quyen','Viet Nam',5500)
INSERT INTO SanPham VALUES('TV05','Tap 100 trang','chuc','Viet Nam',23000)
INSERT INTO SanPham VALUES('TV06','Tap 200 trang','chuc','Viet Nam',53000)
INSERT INTO SanPham VALUES('TV07','Tap 100 trang','chuc','Trung Quoc',34000)
INSERT INTO SanPham VALUES('ST01','So tay 500 trang','quyen','Trung Quoc',40000)
INSERT INTO SanPham VALUES('ST02','So tay loai 1','quyen','Viet Nam',55000)
INSERT INTO SanPham VALUES('ST03','So tay loai 2','quyen','Viet Nam',51000)
INSERT INTO SanPham VALUES('ST04','So tay','quyen','Thai Lan',55000)
INSERT INTO SanPham VALUES('ST05','So tay mong','quyen','Thai Lan',20000)
INSERT INTO SanPham VALUES('ST06','Phan viet bang','hop','Viet Nam',5000)
INSERT INTO SanPham VALUES('ST07','Phan khong bui','hop','Viet Nam',7000)
INSERT INTO SanPham VALUES('ST08','Bong bang','cai','Viet Nam',1000)
INSERT INTO SanPham VALUES('ST09','But long','cay','Viet Nam',5000)
INSERT INTO SanPham VALUES('ST10','But long','cay','Trung Quoc',7000)

INSERT INTO HoaDon VALUES(1001,'23/07/2006','KH01','NV01',320000)
INSERT INTO HoaDon VALUES(1002,'12/08/2006','KH01','NV02',840000)
INSERT INTO HoaDon VALUES(1003,'23/08/2006','KH02','NV01',100000)
INSERT INTO HoaDon VALUES(1004,'01/09/2006','KH02','NV01',180000)
INSERT INTO HoaDon VALUES(1005,'20/10/2006','KH01','NV02',3800000)
INSERT INTO HoaDon VALUES(1006,'16/10/2006','KH01','NV03',2430000)
INSERT INTO HoaDon VALUES(1007,'28/10/2006','KH03','NV03',510000)
INSERT INTO HoaDon VALUES(1008,'28/10/2006','KH01','NV03',440000)
INSERT INTO HoaDon VALUES(1009,'28/10/2006','KH03','NV04',200000)
INSERT INTO HoaDon VALUES(1010,'01/11/2006','KH01','NV01',5200000)
INSERT INTO HoaDon VALUES(1011,'04/11/2006','KH04','NV03',250000)
INSERT INTO HoaDon VALUES(1012,'30/11/2006','KH05','NV03',21000)
INSERT INTO HoaDon VALUES(1013,'12/12/2006','KH06','NV01',5000)
INSERT INTO HoaDon VALUES(1014,'31/12/2006','KH03','NV02',3150000)
INSERT INTO HoaDon VALUES(1015,'01/01/2007','KH06','NV01',910000)
INSERT INTO HoaDon VALUES(1016,'01/01/2007','KH07','NV02',12500)
INSERT INTO HoaDon VALUES(1017,'02/01/2007','KH08','NV03',35000)
INSERT INTO HoaDon VALUES(1018,'13/01/2007','KH08','NV03',330000)
INSERT INTO HoaDon VALUES(1019,'13/01/2007','KH01','NV03',30000)
INSERT INTO HoaDon VALUES(1020,'14/01/2007','KH09','NV04',70000)
INSERT INTO HoaDon VALUES(1021,'16/01/2007','KH10','NV03',67500)
INSERT INTO HoaDon VALUES(1022,'16/01/2007',Null,'NV03',7000)
INSERT INTO HoaDon VALUES(1023,'17/01/2007',Null,'NV01',330000)

INSERT INTO CTHD VALUES(1001,'TV02',10)
INSERT INTO CTHD VALUES(1001,'ST01',5)
INSERT INTO CTHD VALUES(1001,'BC01',5)
INSERT INTO CTHD VALUES(1001,'BC02',10)
INSERT INTO CTHD VALUES(1001,'ST08',10)
INSERT INTO CTHD VALUES(1002,'BC04',20)
INSERT INTO CTHD VALUES(1002,'BB01',20)
INSERT INTO CTHD VALUES(1002,'BB02',20)
INSERT INTO CTHD VALUES(1003,'BB03',10)
INSERT INTO CTHD VALUES(1004,'TV01',20)
INSERT INTO CTHD VALUES(1004,'TV02',10)
INSERT INTO CTHD VALUES(1004,'TV03',10)
INSERT INTO CTHD VALUES(1004,'TV04',10)
INSERT INTO CTHD VALUES(1005,'TV05',50)
INSERT INTO CTHD VALUES(1005,'TV06',50)
INSERT INTO CTHD VALUES(1006,'TV07',20)
INSERT INTO CTHD VALUES(1006,'ST01',30)
INSERT INTO CTHD VALUES(1006,'ST02',10)
INSERT INTO CTHD VALUES(1007,'ST03',10)
INSERT INTO CTHD VALUES(1008,'ST04',8)
INSERT INTO CTHD VALUES(1009,'ST05',10)
INSERT INTO CTHD VALUES(1010,'TV07',50)
INSERT INTO CTHD VALUES(1010,'ST07',50)
INSERT INTO CTHD VALUES(1010,'ST08',100)
INSERT INTO CTHD VALUES(1010,'ST04',50)
INSERT INTO CTHD VALUES(1010,'TV03',100)
INSERT INTO CTHD VALUES(1011,'ST06',50)
INSERT INTO CTHD VALUES(1012,'ST07',3)
INSERT INTO CTHD VALUES(1013,'ST08',5)
INSERT INTO CTHD VALUES(1014,'BC02',80)
INSERT INTO CTHD VALUES(1014,'BB02',100)
INSERT INTO CTHD VALUES(1014,'BC04',60)
INSERT INTO CTHD VALUES(1014,'BB01',50)
INSERT INTO CTHD VALUES(1015,'BB02',30)
INSERT INTO CTHD VALUES(1015,'BB03',7)
INSERT INTO CTHD VALUES(1016,'TV01',5)
INSERT INTO CTHD VALUES(1017,'TV02',1)
INSERT INTO CTHD VALUES(1017,'TV03',1)
INSERT INTO CTHD VALUES(1017,'TV04',5)
INSERT INTO CTHD VALUES(1018,'ST04',6)
INSERT INTO CTHD VALUES(1019,'ST05',1)
INSERT INTO CTHD VALUES(1019,'ST06',2)
INSERT INTO CTHD VALUES(1020,'ST07',10)
INSERT INTO CTHD VALUES(1021,'ST08',5)
INSERT INTO CTHD VALUES(1021,'TV01',7)
INSERT INTO CTHD VALUES(1021,'TV02',10)
INSERT INTO CTHD VALUES(1022,'ST07',1)
INSERT INTO CTHD VALUES(1023,'ST04',6)
--2
SELECT * FROM SanPham,KhachHang
--3
UPDATE SanPham SET GIA=GIA+GIA*1.05 WHERE NUOCSX='SINGAPORE'
--4
UPDATE SanPham SET GIA =GIA - GIA*0.05 WHERE NUOCSX='TRUNG QUOC' AND GIA >10000
--5
UPDATE KhachHang SET LOAIKH ='Vip' WHERE (NGDK<'2011/1/1' AND DOANHSO>=10000000) OR (NGDK>'2011/1/1' AND DOANHSO >=2000000)
-----------------------------------------------------------------------------------------------------------------------
--III

--1
SELECT MASP, TENSP
FROM SanPham
WHERE NUOCSX = 'TRUNG QUOC'
--2
SELECT MASP, TENSP
FROM SanPham
WHERE DVT IN('CAY', 'QUYEN')
--3
SELECT MASP, TENSP
FROM SanPham
WHERE MASP LIKE'B%01'
--4
SELECT MASP,TENSP,NUOCSX
FROM SanPham
WHERE NUOCSX = 'TRUNG QUOC'
AND GIA BETWEEN 30000 AND 40000
--5
SELECT MASP, TENSP, NUOCSX
FROM SanPham
WHERE (NUOCSX = 'TRUNG QUOC' OR NUOCSX = 'THAI LAN') AND GIA BETWEEN 30000 AND 40000
--6
SELECT SOHD, TRIGIA
FROM HOADON
WHERE NGHD >= '1/1/2007' AND NGHD <= '1/2/2007'
--7
SELECT SOHD, TRIGIA
FROM HOADON
WHERE MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007
ORDER BY NGHD ASC, TRIGIA DESC
--8
SELECT K.MAKH, HOTEN
FROM KhachHang K INNER JOIN HOADON H
ON K.MAKH = H.MAKH
WHERE NGHD = '1/1/2007'
--9
SELECT SOHD, TRIGIA
FROM HOADON H INNER JOIN NHANVIEN N
ON H.MANV = N.MANV
WHERE NGHD = '28/10/2006'
AND HOTEN = 'NGUYEN VAN B'
--10
SELECT DISTINCT S.MASP, TENSP
FROM SanPham S INNER JOIN CTHD C
ON S.MASP = C.MASP
AND EXISTS(SELECT *
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006 AND MAKH IN(SELECT H.MAKH
FROM HOADON H INNER JOIN KhachHang K
ON H.MAKH = K.MAKH
WHERE HOTEN = 'NGUYEN VAN A') AND S.MASP = C.MASP)
--11
SELECT SOHD
FROM CTHD
WHERE MASP IN ('BB01', 'BB02')
--12
SELECT SOHD
FROM CTHD
WHERE MASP IN ('BB01', 'BB02')
AND SL BETWEEN 10 AND 20
--13
SELECT SOHD
FROM CTHD A
WHERE A.MASP = 'BB01'
AND SL BETWEEN 10 AND 20
AND EXISTS(SELECT *
FROM CTHD B
WHERE B.MASP = 'BB02'
AND SL BETWEEN 10 AND 20
AND A.SOHD = B.SOHD)
--14
SELECT DISTINCT S.MASP, TENSP
FROM SanPham S INNER JOIN CTHD C
ON S.MASP = C.MASP
WHERE NUOCSX = 'TRUNG QUOC'
AND C.SOHD IN(SELECT DISTINCT C2.SOHD
FROM CTHD C2 INNER JOIN HOADON H
ON C2.SOHD = H.SOHD
WHERE NGHD ='1/1/2007')
--15
SELECT S.MASP, TENSP
FROM SanPham S
WHERE NOT EXISTS(SELECT * 
FROM SanPham S2 INNER JOIN CTHD C
ON S2.MASP = C.MASP
AND S2.MASP = S.MASP)
--16
SELECT S.MASP, TENSP
FROM SanPham S
WHERE S.MASP NOT IN(SELECT C.MASP 
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
WHERE YEAR(NGHD) = 2006)
--17
SELECT S.MASP, TENSP
FROM SanPham S
WHERE NUOCSX = 'TRUNG QUOC' AND S.MASP NOT IN(SELECT C.MASP 
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
WHERE YEAR(NGHD) = 2006)
--18
SELECT H.SOHD 
FROM HOADON H
WHERE NOT EXISTS(SELECT *
FROM SanPham S
WHERE NUOCSX = 'SINGAPORE'
AND NOT EXISTS(SELECT * 
FROM CTHD C
WHERE C.SOHD = H.SOHD
AND C.MASP = S.MASP))
--19
SELECT H.SOHD 
FROM HOADON H
WHERE YEAR(NGHD) = 2006 AND NOT EXISTS(SELECT *
FROM SanPham S
WHERE NUOCSX = 'SINGAPORE'
AND NOT EXISTS(SELECT * 
FROM CTHD C
WHERE C.SOHD = H.SOHD
AND C.MASP = S.MASP))
--20
SELECT COUNT(*)
FROM HOADON H
WHERE MAKH NOT IN(SELECT MAKH
FROM KhachHang K 
WHERE K.MAKH = H.MAKH)
--21
SELECT COUNT(DISTINCT MASP)
FROM CTHD C INNER JOIN HOADON H
ON C.SOHD = H.SOHD
WHERE YEAR(NGHD) = 2006
--22.	Cho biết trị giá hóa đơn cao nhất, thấp nhất là bao nhiêu ?
SELECT MAX(TRIGIA) AS MAX, MIN(TRIGIA) AS MIN
FROM HOADON
--23
SELECT AVG(TRIGIA) TB
FROM HOADON
--24
SELECT SUM(TRIGIA) AS DOANHTHU
FROM HOADON
WHERE YEAR(NGHD) = 2006
--25
SELECT SOHD
FROM HOADON
WHERE TRIGIA = (SELECT MAX(TRIGIA)
FROM HOADON)